<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Honeypot-as-a-Service · Dashboard</title>
<style>
  :root {
    --bg:       #0a0e1a;
    --surface:  #111827;
    --border:   #1f2937;
    --green:    #00ff41;
    --red:      #ff3b3b;
    --yellow:   #fbbf24;
    --text:     #e2e8f0;
    --muted:    #6b7280;
    --radius:   8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Courier New', Courier, monospace;
    min-height: 100vh;
  }

  /* ── Header ─────────────────────────────────────────── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  header h1 { color: var(--green); font-size: 1.3rem; letter-spacing: 2px; }
  #status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    display: inline-block; margin-right: 6px;
  }
  #last-updated { color: var(--muted); font-size: .75rem; }

  /* ── Layout ─────────────────────────────────────────── */
  main { padding: 1.5rem 2rem; }
  h2   { color: var(--green); font-size: .9rem; letter-spacing: 1px; margin-bottom: .75rem; }

  /* ── Stat cards ─────────────────────────────────────── */
  #stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    text-align: center;
  }
  .stat-card .label { color: var(--muted); font-size: .7rem; letter-spacing: 1px; }
  .stat-card .value { color: var(--green); font-size: 2rem; font-weight: bold; margin-top: .25rem; }

  /* ── Two-column row ─────────────────────────────────── */
  #middle-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  @media (max-width: 800px) { #middle-row { grid-template-columns: 1fr; } }

  /* ── Panels ─────────────────────────────────────────── */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
  }

  /* ── Attack type bars ───────────────────────────────── */
  .bar-row { margin-bottom: .5rem; }
  .bar-label { display: flex; justify-content: space-between; font-size: .75rem; margin-bottom: 3px; }
  .bar-track { background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; }
  .bar-fill  { height: 100%; background: var(--green); border-radius: 4px; transition: width .4s; }

  /* ── Honeypot controls ──────────────────────────────── */
  .hp-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: .85rem;
  }
  .hp-row:last-child { border-bottom: none; }
  .hp-name { color: var(--text); }
  .hp-meta { color: var(--muted); font-size: .7rem; }
  .badge-running  { color: var(--green); }
  .badge-stopped  { color: var(--red); }
  .btn {
    padding: .25rem .75rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: .75rem;
    font-weight: bold;
    letter-spacing: .5px;
    margin-left: .5rem;
  }
  .btn-start { background: var(--green); color: var(--bg); }
  .btn-stop  { background: var(--red);   color: #fff; }
  .btn:disabled { opacity: .4; cursor: not-allowed; }

  /* ── Feed table ─────────────────────────────────────── */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: .78rem; }
  th {
    text-align: left;
    padding: .5rem .75rem;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  td {
    padding: .45rem .75rem;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  tr:hover td { background: rgba(0,255,65,.04); }
  .tl-LOW      { color: var(--green); }
  .tl-MEDIUM   { color: var(--yellow); }
  .tl-HIGH     { color: #f97316; }
  .tl-CRITICAL { color: var(--red); }
  #no-attacks { color: var(--muted); padding: 1rem .75rem; }
</style>
</head>
<body>

<header>
  <h1>⬡ HONEYPOT-AS-A-SERVICE</h1>
  <div>
    <span id="status-dot"></span>
    <span id="last-updated">Loading…</span>
  </div>
</header>

<main>

  <!-- ── Stat cards ── -->
  <section>
    <h2>▸ OVERVIEW</h2>
    <div id="stats-grid">
      <div class="stat-card"><div class="label">TOTAL ATTACKS</div><div class="value" id="stat-total">—</div></div>
      <div class="stat-card"><div class="label">UNIQUE ATTACKERS</div><div class="value" id="stat-unique">—</div></div>
      <div class="stat-card"><div class="label">ATTACK TYPES</div><div class="value" id="stat-types">—</div></div>
      <div class="stat-card"><div class="label">CRITICAL THREATS</div><div class="value" id="stat-critical" style="color:var(--red)">—</div></div>
    </div>
  </section>

  <!-- ── Middle row ── -->
  <div id="middle-row">

    <!-- Attack type breakdown -->
    <div class="panel">
      <h2>▸ ATTACK TYPES</h2>
      <div id="type-bars">Loading…</div>
    </div>

    <!-- Honeypot controls -->
    <div class="panel">
      <h2>▸ HONEYPOT CONTROLS</h2>
      <div id="hp-controls">Loading…</div>
    </div>

  </div>

  <!-- ── Live feed ── -->
  <section class="panel">
    <h2>▸ LIVE ATTACK FEED <span style="color:var(--muted);font-size:.7rem">(auto-refresh every 5 s)</span></h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Timestamp</th>
            <th>Attacker IP</th>
            <th>Port</th>
            <th>Honeypot</th>
            <th>Attack Type</th>
            <th>Threat</th>
            <th>Pattern</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody id="feed-body">
          <tr><td colspan="9" id="no-attacks">No attacks recorded yet.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ── Alerts feed ── -->
  <section class="panel" style="margin-top:1.5rem">
    <h2>▸ RECENT ALERTS <span style="color:var(--muted);font-size:.7rem">(auto-refresh every 5 s)</span></h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Timestamp</th>
            <th>Attacker IP</th>
            <th>Alert Type</th>
            <th>Detail</th>
          </tr>
        </thead>
        <tbody id="alerts-body">
          <tr><td colspan="5" style="color:var(--muted);padding:1rem .75rem">No alerts recorded yet.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<script>
'use strict';

const API = '';   // same origin

// ── Fetch helpers ────────────────────────────────────────────────────────────

async function apiFetch(path, opts) {
  const r = await fetch(API + path, opts);
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

// ── Statistics ───────────────────────────────────────────────────────────────

async function refreshStats() {
  try {
    const data = await apiFetch('/api/statistics');
    const db   = data.database || {};
    const anal = data.analyzer  || {};

    document.getElementById('stat-total').textContent    = db.total_attacks    ?? 0;
    document.getElementById('stat-unique').textContent   = db.unique_attackers ?? 0;
    const types = db.attacks_by_type || {};
    document.getElementById('stat-types').textContent    = Object.keys(types).length;
    const threatDist = db.attacks_by_threat_level || {};
    document.getElementById('stat-critical').textContent = threatDist['CRITICAL'] ?? 0;

    // Attack type bars
    const maxCount = Math.max(1, ...Object.values(types));
    const barsEl = document.getElementById('type-bars');
    if (Object.keys(types).length === 0) {
      barsEl.textContent = 'No data yet.';
    } else {
      barsEl.innerHTML = Object.entries(types)
        .sort((a,b) => b[1]-a[1])
        .map(([t, c]) => `
          <div class="bar-row">
            <div class="bar-label"><span>${t}</span><span>${c}</span></div>
            <div class="bar-track"><div class="bar-fill" style="width:${(c/maxCount*100).toFixed(1)}%"></div></div>
          </div>`).join('');
    }
  } catch(e) { console.warn('Stats error', e); }
}

// ── Honeypot controls ─────────────────────────────────────────────────────────

const DEFAULT_PORTS = { ssh:2222, http:8080, ftp:2121 };

async function refreshHoneypots() {
  try {
    const data = await apiFetch('/api/honeypots');
    const running = {};
    (data.honeypots || []).forEach(h => { running[h.type] = h; });

    const ctrl = document.getElementById('hp-controls');
    ctrl.innerHTML = ['ssh','http','ftp'].map(t => {
      const info    = running[t];
      const isUp    = info && info.is_running;
      const badge   = isUp
        ? `<span class="badge-running">● RUNNING :${info.port}</span>`
        : `<span class="badge-stopped">○ STOPPED</span>`;
      return `
        <div class="hp-row">
          <div>
            <div class="hp-name">${t.toUpperCase()} Honeypot</div>
            <div class="hp-meta">${badge}</div>
          </div>
          <div>
            <button class="btn btn-start" onclick="startHoneypot('${t}')" ${isUp?'disabled':''}>START</button>
            <button class="btn btn-stop"  onclick="stopHoneypot('${t}')"  ${!isUp?'disabled':''}>STOP</button>
          </div>
        </div>`;
    }).join('');
  } catch(e) { console.warn('Honeypot status error', e); }
}

async function startHoneypot(type) {
  try {
    await apiFetch('/api/honeypots/start', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type, host:'0.0.0.0', port: DEFAULT_PORTS[type] })
    });
    await refreshHoneypots();
  } catch(e) { alert('Could not start honeypot: ' + e.message); }
}

async function stopHoneypot(type) {
  try {
    await apiFetch('/api/honeypots/stop', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type })
    });
    await refreshHoneypots();
  } catch(e) { alert('Could not stop honeypot: ' + e.message); }
}

// ── Attack feed ──────────────────────────────────────────────────────────────

async function refreshFeed() {
  try {
    const data = await apiFetch('/api/attacks?limit=50');
    const tbody = document.getElementById('feed-body');
    const attacks = data.attacks || [];
    if (attacks.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" id="no-attacks">No attacks recorded yet.</td></tr>';
      return;
    }
    tbody.innerHTML = attacks.map(a => {
      const tl  = (a.threat_level || 'LOW').toUpperCase();
      const raw = (a.raw_data || '').slice(0, 60).replace(/</g,'&lt;');
      return `<tr>
        <td>${a.id}</td>
        <td>${(a.timestamp||'').replace('T',' ').slice(0,19)}</td>
        <td style="color:var(--green)">${a.attacker_ip}</td>
        <td>${a.attacker_port}</td>
        <td>${a.honeypot_type}</td>
        <td>${a.attack_type}</td>
        <td class="tl-${tl}">${tl}</td>
        <td>${a.attack_pattern||''}</td>
        <td style="color:var(--muted)">${raw}</td>
      </tr>`;
    }).join('');
  } catch(e) { console.warn('Feed error', e); }
}

// ── Alerts feed ──────────────────────────────────────────────────────────────

async function refreshAlerts() {
  try {
    const data = await apiFetch('/api/alerts?limit=20');
    const tbody = document.getElementById('alerts-body');
    const alerts = data.alerts || [];
    if (alerts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted);padding:1rem .75rem">No alerts recorded yet.</td></tr>';
      return;
    }
    tbody.innerHTML = alerts.map(a => `<tr>
      <td>${a.id}</td>
      <td>${(a.timestamp||'').replace('T',' ').slice(0,19)}</td>
      <td style="color:var(--red)">${a.attacker_ip}</td>
      <td style="color:var(--yellow)">${a.alert_type}</td>
      <td style="color:var(--muted)">${(a.detail||'').slice(0,80)}</td>
    </tr>`).join('');
  } catch(e) { console.warn('Alerts error', e); }
}

// ── Ticker ───────────────────────────────────────────────────────────────────

function updateTimestamp() {
  document.getElementById('last-updated').textContent =
    'Last updated: ' + new Date().toLocaleTimeString();
}

async function tick() {
  await Promise.all([refreshStats(), refreshHoneypots(), refreshFeed(), refreshAlerts()]);
  updateTimestamp();
}

tick();
setInterval(tick, 5000);
</script>
</body>
</html>
